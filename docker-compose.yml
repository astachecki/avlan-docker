version: "2"

services:
  avlan-mysql:
    build: ./avlan-mysql
    image: avlan-mysql:latest
    container_name: "avlan-mysql"
    environment:
      - MYSQL_ROOT_PASSWORD=avlan
      - MYSQL_USER=avlan
      - MYSQL_PASSWORD=avlan
      - MYSQL_DATABASE=avlan
    volumes:
      - ./run/avlan-mysql:/var/lib/mysql

  avlan:
    build: ./avlan
    image: avlan:latest
    depends_on:
      - avlan-mysql
    container_name: "avlan"
    restart: always
    ports:
      - "3000:8000"
    links:
      - mysql
    volumes:
      - ./run/avlan/user_uploads:/app/user_uploads
      - ./run/avlan/webroot:/app/webroot
    external_links:
      - avlan-mysql:mysql.internal

  nginx-proxy:
    build: ./nginx-proxy
    image: nginx-proxy:latest
    depends_on:
      - avlan
    container_name: "nginx"
    ports:
      - "80:80"
    environment:
      - NGINX_HOST=avlan.local
      - NGINX_PORT=80
    volumes_from:
      - avlan:ro
    external_links:
      - avlan:avlan.internal
    command: /bin/bash -c "envsubst '$$NGINX_HOST $$NGINX_PORT' < /etc/nginx/nginx.tmpl > /etc/nginx/nginx.conf && nginx -g 'daemon off;'"
